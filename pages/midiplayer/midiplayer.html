<!DOCTYPE html>
<html>

<head>
	<script src='https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js'></script>
    <script src='MIDIFile.js'></script>
</head>

<body>
	<div id='cntls'></div>
	<script type="module">
        import { joinRoom } from 'https://cdn.skypack.dev/pin/trystero@v0.11.8-pxKZpWfVVzXootkGlZMp/mode=imports,min/optimized/trystero.js';

		console.log('start');
		var audioContext = null;
		var player = null;
		var reverberator = null;
		var equalizer = null;
		var songStart = 0;
		var input = null;
        var playing = false;
        var room = null;
        var isControl = false;
        var sendMessage = true;
        var peers = [];
		var playerSongTime = 0;
		var loadedsong = null;

        function setupRoom() {
            const roomid = (Math.random() + 1).toString(36).substring(7);
            let url = window.location.href;
            if (url.indexOf('?') > -1) {
                url += '&room=' + roomid
            } else {
                url += '?room=' + roomid
            }
            window.location.href = url;
        }

        function enterRoom(roomid) {
            room = joinRoom({appId: 'cyprus-choir-club'}, roomid);

            const [sendTick1, getTick1] = room.makeAction('message')
            sendMessage = sendTick1
            document.getElementById("room_url").innerHTML = "joined " + roomid;
            getTick1((data, peerId) => {
                if (data.isControl && !isControl) {
                    adjustStateFromControl(data)
                }
            })
        }

        function setControl(value) {
            isControl = value;
            if (value) {
                document.getElementById('mode').innerHTML = 'Control mode';
            } else {
                document.getElementById('mode').innerHTML = 'Follow mode';
            }
        }

        function adjustStateFromControl(data) {
            var wasPlaying = playing;
            var contextTime = audioContext.currentTime;

            songStart = data.songStart - data.contextTime + contextTime;

            if (wasPlaying !== data.playing) {
                if (!wasPlaying) {
                    playerSongTime = audioContext.currentTime - songStart;
                }
                playOrPause();
            }
        }

        function startFollowing() {
            setControl(false)
        }

        function playButtonClick() {
            setControl(true)
            playOrPause()
        }

		function playOrPause() {
            if (!playing) {
                playing = true;
                document.getElementById('tmr').innerHTML = 'starting...';
                try {
                    startPlay(loadedsong);
                    document.getElementById('tmr').innerHTML = 'playing...';
                    document.getElementById('playbtn').innerHTML = 'Pause';
                } catch (expt) {
                    document.getElementById('tmr').innerHTML = 'error ' + expt;
                }
            } else {
                playing = false
                playerSongTime = audioContext.currentTime - songStart;
                renderProgress(loadedsong, playerSongTime);
                document.getElementById('tmr').innerHTML = 'paused';
                document.getElementById('playbtn').innerHTML = 'Play';
                player.cancelQueue(audioContext)
                sendStatus(true)
            }
		}
		function startPlay(song) {
			songStart = audioContext.currentTime - playerSongTime;
			var stepDuration = 5000 / 1000;
			startTicks(song, stepDuration);
		}
        function startTicks(song, stepDuration) {
            tickByInterval(song, stepDuration);
        }
        function tickByInterval(song, stepDuration) {
            tick(song, stepDuration);
            var timer = setInterval(function () {
                var requiresNext = tick(song, stepDuration);
                if (!requiresNext) {
                    clearInterval(timer);
                }
            }, stepDuration * 1000);
        }
		function tick(song, advance) {
            var currentSongTime = audioContext.currentTime - songStart;
            sendStatus();
            if (!playing) return false

            console.log('player at ' + playerSongTime + ', advance ' + advance);
            sendNotes(song, songStart, playerSongTime, currentSongTime + advance, audioContext, input, player);
            playerSongTime = currentSongTime + advance;
            console.log('played to ' + playerSongTime);
            if (playerSongTime > song.duration) {
                return false
            }

            renderProgress(song, currentSongTime);
            return true;
		}
        function sendStatus(fromAction = false) {
            for (const friendId of room.getPeers()) {
                sendMessage({
                    songStart: songStart,
                    contextTime: audioContext.currentTime,
                    playing: playing,
                    fromAction: fromAction,
                    isControl: isControl,
                }, friendId)
            }
        }
        function renderProgress(song, currentSongTime) {
            var o = document.getElementById('position');
            o.value = 100 * currentSongTime / song.duration;
            document.getElementById('tmr').innerHTML = '' + Math.round(100 * currentSongTime / song.duration) + '%';
            document.getElementById('currentTime').innerHTML = '' + Math.round(audioContext.currentTime * 1000);
            document.getElementById('currentSongTime').innerHTML = '' + Math.round(currentSongTime * 1000);
            document.getElementById('songStart').innerHTML = '' + Math.round(songStart * 1000);
        }
		function sendNotes(song, songStart, start, end, audioContext, input, player) {
			for (var t = 0; t < song.tracks.length; t++) {
				var track = song.tracks[t];
				for (var i = 0; i < track.notes.length; i++) {
					if (track.notes[i].when >= start && track.notes[i].when < end) {
						var when = songStart + track.notes[i].when;
						var duration = track.notes[i].duration;
						if (duration > 3) {
							duration = 3;
						}
						var instr = track.info.variable;
						var v = track.volume / 7;
						player.queueWaveTable(audioContext, input, window[instr], when, track.notes[i].pitch, duration, v, track.notes[i].slides);
					}
				}
			}
			for (var b = 0; b < song.beats.length; b++) {
				var beat = song.beats[b];
				for (var i = 0; i < beat.notes.length; i++) {
					if (beat.notes[i].when >= start && beat.notes[i].when < end) {
						var when = songStart + beat.notes[i].when;
						var duration = 1.5;
						var instr = beat.info.variable;
						var v = beat.volume / 2;
						player.queueWaveTable(audioContext, input, window[instr], when, beat.n, duration, v);
					}
				}
			}
		}
		function startLoad(song) {
			console.log(song);
			var AudioContextFunc = window.AudioContext || window.webkitAudioContext;
			audioContext = new AudioContextFunc();
			player = new WebAudioFontPlayer();

			equalizer = player.createChannel(audioContext);
			reverberator = player.createReverberator(audioContext);
			//input = reverberator.input;
			input = equalizer.input;
			equalizer.output.connect(reverberator.input);
			reverberator.output.connect(audioContext.destination);

			for (var i = 0; i < song.tracks.length; i++) {
				var nn = player.loader.findInstrument(song.tracks[i].program);
				var info = player.loader.instrumentInfo(nn);
				song.tracks[i].info = info;
				song.tracks[i].id = nn;
				player.loader.startLoad(audioContext, info.url, info.variable);
			}
			for (var i = 0; i < song.beats.length; i++) {
				var nn = player.loader.findDrum(song.beats[i].n);
				var info = player.loader.drumInfo(nn);
				song.beats[i].info = info;
				song.beats[i].id = nn;
				player.loader.startLoad(audioContext, info.url, info.variable);
			}
			player.loader.waitLoad(function () {
				console.log('buildControls');
				buildControls(song);
				resetEqlualizer();
			});
		}
		function resetEqlualizer(){
			equalizer.band32.gain.setTargetAtTime(2,0,0.0001);
			equalizer.band64.gain.setTargetAtTime(2,0,0.0001);
			equalizer.band128.gain.setTargetAtTime(1,0,0.0001);
			equalizer.band256.gain.setTargetAtTime(0,0,0.0001);
			equalizer.band512.gain.setTargetAtTime(-1,0,0.0001);
			equalizer.band1k.gain.setTargetAtTime(5,0,0.0001);
			equalizer.band2k.gain.setTargetAtTime(4,0,0.0001);
			equalizer.band4k.gain.setTargetAtTime(3,0,0.0001);
			equalizer.band8k.gain.setTargetAtTime(-2,0,0.0001);
			equalizer.band16k.gain.setTargetAtTime(2,0,0.0001);
		}
		function buildControls(song) {
			audioContext.resume();
			var o = document.getElementById('cntls');
			var html = '<h2 id="wrng">Midi player by <a href="https://github.com/surikov/webaudiofont/tree/master">WebAudioFont</a></h2>';
			html = html + '<p><button id="playbtn"">Play</button></p>';
			html = html + '<p><button id="followbtn">Follow</button></p>';
            html = html + '<p id="mode">Player mode</p>';
            html = html + '<p id="tmr">sdfsdf</p>';
            html = html + '<p id="room_url">room_url</p>';
            html = html + '<p id="currentTime">currentTime</p>';
            html = html + '<p id="songStart">songStart</p>';
            html = html + '<p id="currentSongTime">currentSongTime</p>';
			html = html + '<p><input id="position" type="range" min="0" max="100" value="0" step="1" /></p>';
			html = html + '<h3>Channels</h3>';
			for (var i = 0; i < song.tracks.length; i++) {
				var v = 100 * song.tracks[i].volume;
				html = html + '<p>' + chooserIns(song.tracks[i].id, i) + '<input id="channel' + i + '" type="range" min="0" max="100" value="' + v + '" step="1" /></p>';
			}
			html = html + '<h3>Drums</h3>';
			for (var i = 0; i < song.beats.length; i++) {
				var v = 100 * song.beats[i].volume;
				html = html + '<p>' + chooserDrum(song.beats[i].id, i) + '<input id="drum' + i + '" type="range" min="0" max="100" value="' + v + '" step="1" /></p>';
			}
			o.innerHTML = html;
            document.getElementById('playbtn').addEventListener('click', playButtonClick)
            document.getElementById('followbtn').addEventListener('click', startFollowing)
			console.log('Loaded');
            var roomid = getParam("room");
            if (roomid) {
                enterRoom(roomid)
                setControl(true)
            } else {
                setupRoom()
            }
			var pos = document.getElementById('position');
			pos.oninput = function (e) {
				if (loadedsong) {
					player.cancelQueue(audioContext);
					var next = song.duration * pos.value / 100;
					songStart = songStart - (next - playerSongTime);
					playerSongTime = next;
                    console.log('positioned at ' + playerSongTime)
				}
			};
			console.log('Tracks');
			for (var i = 0; i < song.tracks.length; i++) {
				setVolumeAction(i, song);
			}
			console.log('Drums');
			for (var i = 0; i < song.beats.length; i++) {
				setDrVolAction(i, song);
			}
			loadedsong = song;
		}
		function setVolumeAction(i, song) {
			var vlm = document.getElementById('channel' + i);
			vlm.oninput = function (e) {
				player.cancelQueue(audioContext);
				var v = vlm.value / 100;
				if (v < 0.000001) {
					v = 0.000001;
				}
				song.tracks[i].volume = v;
			};
			var sl = document.getElementById('selins' + i);
			sl.onchange = function (e) {
				var nn = sl.value;
				var info = player.loader.instrumentInfo(nn);
				player.loader.startLoad(audioContext, info.url, info.variable);
				player.loader.waitLoad(function () {
					console.log('loaded');
					song.tracks[i].info = info;
					song.tracks[i].id = nn;
				});
			};
		}
		function setDrVolAction(i, song) {
			var vlm = document.getElementById('drum' + i);
			vlm.oninput = function (e) {
				player.cancelQueue(audioContext);
				var v = vlm.value / 100;
				if (v < 0.000001) {
					v = 0.000001;
				}
				song.beats[i].volume = v;
			};
			var sl = document.getElementById('seldrm' + i);
			sl.onchange = function (e) {
				var nn = sl.value;
				var info = player.loader.drumInfo(nn);
				player.loader.startLoad(audioContext, info.url, info.variable);
				player.loader.waitLoad(function () {
					console.log('loaded');
					song.beats[i].info = info;
					song.beats[i].id = nn;
				});
			};
		}
		function chooserIns(n, track) {
			var html = '<select id="selins' + track + '">';
			for (var i = 0; i < player.loader.instrumentKeys().length; i++) {
				var sel = '';
				if (i == n) {
					sel = ' selected';
				}
				html = html + '<option value="' + i + '"' + sel + '>' + i + ': ' + player.loader.instrumentInfo(i).title + '</option>';
			}
			html = html + '</select>';
			return html;
		}
		function chooserDrum(n, beat) {
			var html = '<select id="seldrm' + beat + '">';
			for (var i = 0; i < player.loader.drumKeys().length; i++) {
				var sel = '';
				if (i == n) {
					sel = ' selected';
				}
				html = html + '<option value="' + i + '"' + sel + '>' + i + ': ' + player.loader.drumInfo(i).title + '</option>';
			}
			html = html + '</select>';
			return html;
		}
		function handleFileSelect(event) {
			console.log(event);
			var file = event.target.files[0];
			console.log(file);
			var fileReader = new FileReader();
			fileReader.onload = function (progressEvent) {
				console.log(progressEvent);
				var arrayBuffer = progressEvent.target.result;
				console.log(arrayBuffer);
				var midiFile = new MIDIFile(arrayBuffer);
				var song = midiFile.parseSong();
				startLoad(song);
			};
			fileReader.readAsArrayBuffer(file);
		}
		function handleExample(path) {
			console.log(path);
			var xmlHttpRequest = new XMLHttpRequest();
			xmlHttpRequest.open("GET", path, true);
			xmlHttpRequest.responseType = "arraybuffer";
			xmlHttpRequest.onload = function (e) {
				var arrayBuffer = xmlHttpRequest.response;
				var midiFile = new MIDIFile(arrayBuffer);
				var song = midiFile.parseSong();
				startLoad(song);
			};
			xmlHttpRequest.send(null);
		}
        function getParam(param) {
            return new URL(document.URL).searchParams.get(param)
        }
        handleExample("../" + getParam("midiFile"))
	</script>
</body>

</html>