<!DOCTYPE html>
<html>

<head>
	<script src='https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js'></script>
    <script src='MIDIFile.js'></script>
</head>

<body>
    <button id="initLoad">Load</button>
	<div id='cntls'></div>
	<script type="module">
        import { joinRoom, selfId } from 'https://cdn.skypack.dev/pin/trystero@v0.11.8-pxKZpWfVVzXootkGlZMp/mode=imports,min/optimized/trystero.js';

        const MODE_STANDALONE = "standalone"
        const MODE_CONTROL = "control"
        const MODE_FOLLOW = "follow"

		var audioContext = null;
		var player = null;
		var reverberator = null;
		var equalizer = null;
		var songStart = 0;
		var input = null;
        var playing = false;
        var tempoCoeff = 1.0;
        var room = null;
        var mode = MODE_STANDALONE;
        var currentControl = null;
        var sendMessage = null;
        var peerTimeDiff = {};
        var peerLatency = {};
        var peerPersistentId = {};
        var peerDelay = {};
		var playerSongTime = 0;
		var loadedsong = null;

        function reopenWithRandomRoom() {
            const roomid = (Math.random() + 1).toString(36).substring(7);
            let url = window.location.href;
            if (url.indexOf('?') > -1) {
                url += '&room=' + roomid
            } else {
                url += '?room=' + roomid
            }
            window.location.href = url;
        }

        function enterRoom(roomid) {
            if (!room) {
                room = joinRoom({appId: 'cyprus-choir-club'}, roomid);
                room.onPeerJoin(peerId => {
                    sendStatus(true, false)
                    renderPeers()
                })
                room.onPeerLeave(peerId => {
                    renderPeers()
                })

                const [sendTick1, getTick1] = room.makeAction('message')
                sendMessage = sendTick1
                getTick1((data, peerId) => {
                    receiveMessage(data, peerId)
                })
            }
            renderPeers()
        }
        function leaveRoom() {
            if (room) {
                room.leave()
                room = null
                sendMessage = null
            }
            renderPeers()
        }

        function receiveMessage(data, peerId) {
            console.log("received message from peer " + peerId + " " + JSON.stringify(data))
            if (data.mode === MODE_CONTROL) {
                currentControl = peerId;
            }
            if (data.mode !== MODE_CONTROL && currentControl === peerId) {
                currentControl = null;
            }
            if (data.mode === MODE_CONTROL && mode === MODE_CONTROL && data.interceptControl) {
                setControl(MODE_FOLLOW)
            }
            if (data.mode === MODE_FOLLOW && mode === MODE_CONTROL || data.mode === MODE_CONTROL && mode === MODE_FOLLOW) {
                updatePeerTimeDiff(data, peerId)
            }
            peerPersistentId[peerId] = data.persistentId;
            if (data.mode === MODE_CONTROL && mode === MODE_FOLLOW) {
                adjustStateFromControl(data, peerId)
            }
            renderPeers()
        }

        function updatePeerTimeDiff(data, peerId) {
            peerLatency[peerId] = peerTimeDiff[peerId] + data.timeDiff;
            if (data.contextTime > 0 && audioContext.currentTime > 0) {
                var timeDiff = data.contextTime - audioContext.currentTime + audioContext.baseLatency + audioContext.outputLatency - data.baseLatency - data.outputLatency;
                if (isFinite(timeDiff)) {
                    if (isFinite(peerTimeDiff[peerId])) {
                        peerTimeDiff[peerId] = (peerTimeDiff[peerId] * 9 + timeDiff) / (9 + 1);
                    } else {
                        peerTimeDiff[peerId] = timeDiff;
                    }
                }
            }
        }

        function setControl(value) {
            mode = value;
            if (mode === MODE_STANDALONE) {
                document.getElementById('standalone').checked = true;
            }
            if (mode === MODE_CONTROL) {
                currentControl = selfId;
                document.getElementById('control').checked = true;
            }
            if (mode === MODE_FOLLOW) {
                document.getElementById('follow').checked = true;
            }
            if (mode === MODE_CONTROL || mode === MODE_FOLLOW) {
                var roomId = getParam("room")
                enterRoom(roomId)
            } else {
                leaveRoom()
            }
            if (mode === MODE_FOLLOW) {
                document.getElementById('playbtn').disabled = true;
            } else {
                document.getElementById('playbtn').disabled = false;
            }
            sendStatus(false)
        }

        function adjustStateFromControl(data, peerId) {
            var wasPlaying = playing;

            var contextTimeDiff;
            if (peerTimeDiff[peerId] && data.timeDiff) {
                if (isFinite(data.peerDelay)) {
                    contextTimeDiff = (peerTimeDiff[peerId] - data.timeDiff - data.peerDelay) / 2 + (peerDelay[peerId] ? peerDelay[peerId] / 1000 : 0);
                } else {
                    contextTimeDiff = (peerTimeDiff[peerId] - data.timeDiff) / 2 + (peerDelay[peerId] ? peerDelay[peerId] / 1000 : 0);
                }
            } else {
                contextTimeDiff = data.contextTime - audioContext.currentTime + (peerDelay[peerId] ? peerDelay[peerId]/1000 : 0);
            }

            songStart = data.songStart - contextTimeDiff;
            tempoCoeff = data.tempoCoeff;

            if (!wasPlaying && data.playing) {
                playerSongTime = (audioContext.currentTime - songStart) * tempoCoeff;
                play()
            }
            if (wasPlaying && !data.playing) {
                pause()
            }
        }

        function modeSelectChange() {
            if (document.getElementById('standalone').checked) {
                pause()
                setControl(MODE_STANDALONE)
            }
            if (document.getElementById('control').checked) {
                setControl(MODE_CONTROL)
            }
            if (document.getElementById('follow').checked) {
                pause()
                setControl(MODE_FOLLOW)
            }
        }

        function playButtonClick() {
            if (mode === MODE_FOLLOW) {
                setControl(MODE_STANDALONE)
            }
            if (!playing) {
                play()
            } else {
                pause()
            }
        }

        function play() {
            if (playing) return;
            playing = true;
            document.getElementById('tmr').innerHTML = 'starting...';
            try {
                startPlay(loadedsong);
                document.getElementById('tmr').innerHTML = 'playing...';
                document.getElementById('playbtn').classList.add('playing');
            } catch (expt) {
                document.getElementById('tmr').innerHTML = 'error ' + expt;
            }
        }
        function pause() {
            if (!playing) return;
            playing = false
            playerSongTime = (audioContext.currentTime - songStart) * tempoCoeff;
            renderProgress(loadedsong, playerSongTime);
            document.getElementById('tmr').innerHTML = 'paused';
            document.getElementById('playbtn').classList.remove('playing');
            player.cancelQueue(audioContext)
            sendStatus()
        }
		function startPlay(song) {
            songStart = audioContext.currentTime - playerSongTime / tempoCoeff;
			var stepDuration = 176 / 1000;
			startTicks(song, stepDuration);
		}
        function startTicks(song, stepDuration) {
            tickByInterval(song, stepDuration);
        }
        function tickByInterval(song, stepDuration) {
            tick(song, stepDuration);
            var timer = setInterval(function () {
                var requiresNext = tick(song, stepDuration * 3);
                if (!requiresNext) {
                    clearInterval(timer);
                }
            }, stepDuration * 1000);
        }
		function tick(song, advance) {
            var currentSongTime = (audioContext.currentTime - songStart) * tempoCoeff
            sendStatus();
            if (!playing) return false

            sendNotes(song, songStart, playerSongTime, currentSongTime + advance, audioContext, input, player);
            playerSongTime = currentSongTime + advance;
            if (currentSongTime > song.duration) {
                pause()
                playerSongTime = 0
                return false
            }

            renderProgress(song, currentSongTime);
            return true;
		}
        function sendStatusToPeer(peerId, interceptControl = true) {
            let message = {
                songStart: songStart,
                tempoCoeff: tempoCoeff,
                contextTime: audioContext.currentTime,
                timeDiff: peerTimeDiff[peerId],
                peerDelay: peerDelay[peerId] ? peerDelay[peerId] / 1000 : 0,
                playing: playing,
                mode: mode,
                persistentId: localStorage.getItem("persistentId"),
                baseLatency: audioContext.baseLatency,
                outputLatency: audioContext.outputLatency,
                interceptControl: interceptControl,
            };
            console.log("sending status to peer " + peerId + " " + JSON.stringify(message))
            sendMessage(message, peerId)
        }
        function sendStatus(filter = true, interceptControl = true) {
            if (room) {
                for (const peerId of room.getPeers()) {
                    if (mode === MODE_CONTROL || peerId === currentControl || !filter) {
                        sendStatusToPeer(peerId, interceptControl)
                    }
                }
            }
        }
        function renderPeers() {
            var list = "";
            if (mode === MODE_CONTROL || mode === MODE_FOLLOW) {
                let peers = room.getPeers();
                list = list + `<tr><td>self:</td><td>${localStorage.getItem("persistentId")}</td><td><samp>${selfId}</samp></td></tr>`
                peers.forEach(function (peerId) {
                    if (peerId === currentControl && mode === MODE_FOLLOW || mode === MODE_CONTROL) {
                        list = list + `<tr>`;
                        list = list + `<td>peer:</td>`;
                        list = list + `<td>${peerPersistentId[peerId]}</td>`;
                        list = list + `<td><samp>${peerId}</samp></td>`;
                        list = list + `<td>delayMs:<input id="${peerId}_delay" style="width: 5em;" type="number" value="${peerDelay[peerId] ? peerDelay[peerId] : 0}" step="10"/></td>`;
                        list = list + `<td>diff ${peerTimeDiff[peerId]}<td>`;
                        list = list + `<td>latency ${peerLatency[peerId]}<td>`;
                        list = list + `</tr>`;
                    }
                })
                document.getElementById('peers_list').innerHTML = `<table>${list}</table>`;
                peers.forEach(function (peerId) {
                    if (peerId === currentControl && mode === MODE_FOLLOW || mode === MODE_CONTROL) {
                        let delayInput = document.getElementById(peerId + '_delay');
                        delayInput.oninput = function (e) {
                            peerDelay[peerId] = delayInput.value;
                        };
                    }
                })
            } else {
                document.getElementById('peers_list').innerHTML = '';
            }
        }
        function setPosition(targetSongTime) {
            setPositionAndTempo(targetSongTime, tempoCoeff)
        }
        function setTempo(targetTempoCoeff) {
            setPositionAndTempo(playerSongTime, targetTempoCoeff)
        }
        function setPositionAndTempo(targetSongTime, targetTempoCoeff) {
            if (loadedsong) {
                // this library doesn't provide a way to cancel notes one by one, so we have to:
                // - either cancel all notes
                // - or listen to then hanging notes until they are finished
                // player.cancelQueue(audioContext);
                songStart = songStart - targetSongTime / targetTempoCoeff + playerSongTime / tempoCoeff;
                playerSongTime = targetSongTime;
                tempoCoeff = targetTempoCoeff;
                tick(loadedsong, 0)
                renderProgress(loadedsong, playerSongTime);
            }
        }
        function renderProgress(song, currentSongTime) {
            var o = document.getElementById('position');
            o.value = 100 * currentSongTime / song.duration;
            document.getElementById('tmr').innerHTML = '' + Math.round(100 * currentSongTime / song.duration) + '%';
            document.getElementById('playCursorText').innerHTML = buildSvgCursorText(song, currentSongTime);
            let cursorAnimateTag = document.getElementById('cursor-animate');
            var cursorPosition = currentSongTime / song.duration * 1000;
            let timeToEnd = (song.duration - currentSongTime) / tempoCoeff;
            var curserPositionAfter10sec
            if (playing) {
                curserPositionAfter10sec = cursorPosition + (1000 - cursorPosition) / timeToEnd * 10;
            } else {
                curserPositionAfter10sec = cursorPosition
            }
            cursorAnimateTag.setAttribute("from", cursorPosition.toString() + ' 0');
            cursorAnimateTag.setAttribute("to", curserPositionAfter10sec.toString() + ' 0');
            cursorAnimateTag.beginElement();
        }
		function sendNotes(song, songStart, start, end, audioContext, input, player) {
			for (var t = 0; t < song.tracks.length; t++) {
				var track = song.tracks[t];
				for (var i = 0; i < track.notes.length; i++) {
					if (track.notes[i].when >= start && track.notes[i].when < end) {
						var when = songStart + track.notes[i].when / tempoCoeff;
						var duration = track.notes[i].duration / tempoCoeff;
						if (duration > 3) {
							duration = 3;
						}
						var instr = track.info.variable;
						var v = track.volume / 7;
						player.queueWaveTable(audioContext, input, window[instr], when, track.notes[i].pitch, duration, v, track.notes[i].slides);
					}
				}
			}
			for (var b = 0; b < song.beats.length; b++) {
				var beat = song.beats[b];
				for (var i = 0; i < beat.notes.length; i++) {
					if (beat.notes[i].when >= start && beat.notes[i].when < end) {
						var when = songStart + beat.notes[i].when / tempoCoeff;
						var duration = 1.5;
						var instr = beat.info.variable;
						var v = beat.volume / 2;
						player.queueWaveTable(audioContext, input, window[instr], when, beat.n, duration, v);
					}
				}
			}
		}
		function startLoad(song) {
			console.log(song);
			var AudioContextFunc = window.AudioContext || window.webkitAudioContext;
			audioContext = new AudioContextFunc();
			player = new WebAudioFontPlayer();

			equalizer = player.createChannel(audioContext);
			// reverberator = player.createReverberator(audioContext);
			//input = reverberator.input;
			input = equalizer.input;
			equalizer.output.connect(audioContext.destination);
			// reverberator.output.connect(audioContext.destination);

			for (var i = 0; i < song.tracks.length; i++) {
				var nn = player.loader.findInstrument(song.tracks[i].program);
				var info = player.loader.instrumentInfo(nn);
				song.tracks[i].info = info;
				song.tracks[i].id = nn;
				player.loader.startLoad(audioContext, info.url, info.variable);
			}
			for (var i = 0; i < song.beats.length; i++) {
				var nn = player.loader.findDrum(song.beats[i].n);
				var info = player.loader.drumInfo(nn);
				song.beats[i].info = info;
				song.beats[i].id = nn;
				player.loader.startLoad(audioContext, info.url, info.variable);
			}
			player.loader.waitLoad(function () {
				buildControls(song);
				resetEqlualizer();
			});
		}
		function resetEqlualizer(){
			equalizer.band32.gain.setTargetAtTime(2,0,0.0001);
			equalizer.band64.gain.setTargetAtTime(2,0,0.0001);
			equalizer.band128.gain.setTargetAtTime(1,0,0.0001);
			equalizer.band256.gain.setTargetAtTime(0,0,0.0001);
			equalizer.band512.gain.setTargetAtTime(-1,0,0.0001);
			equalizer.band1k.gain.setTargetAtTime(5,0,0.0001);
			equalizer.band2k.gain.setTargetAtTime(4,0,0.0001);
			equalizer.band4k.gain.setTargetAtTime(3,0,0.0001);
			equalizer.band8k.gain.setTargetAtTime(-2,0,0.0001);
			equalizer.band16k.gain.setTargetAtTime(2,0,0.0001);
		}
        function buildSvg(song, cursorPosition) {
            var heigth = 50 * song.tracks.length + 40;
            var html = '<svg\n'
            html = html + '  id="playdeck"\n'
            html = html + '  viewBox="0 0 1000 ' + heigth + '"\n'
            html = html + '  width="100%"\n'
            html = html + '  xmlns="http://www.w3.org/2000/svg">\n'
            html = html + '  <rect width="1000" height="' + heigth + '" id="background" fill="#fcffd0" />\n'
            for (var i = 0; i < song.tracks.length; i++) {
                var track = song.tracks[i]
                for (var j = 0; j < track.notes.length; j++) {
                    var note = track.notes[j]
                    var width = note.duration / song.duration
                    var x = note.when / song.duration
                    html = html + '  <rect width="' + (width * 1000) + '" height="10" x="' + (x * 1000) + '" y="' + (20 + 50*i) + '" fill="blue" />\n'
                    html = html + '  <rect width="3" height="30" x="' + (x * 1000) + '" y="' + (10 + 50*i) + '" fill="blue" />\n'
                }
                html = html + '  <rect width="1000" height="2" x="0" y="' + (24 + 50*i) + '" fill="green" />\n'
            }
            html = html + '<rect width="1000" height="10" id="positionBar" x="0" y="' + (50 * song.tracks.length + 20) + '" fill="#fff69b" pointer-events="none" />\n'
            html = html + '  ' + buildSvgCursor(song, cursorPosition) + '\n'
            html = html + '</svg>'
            return html
        }
        function secondsToTimeString(seconds) {
            return new Date(seconds * 1000).toISOString().slice(11, 23)
        }
        function buildSvgCursor(song) {
            var html = '<g id="playCursor">\n'
            html = html + '  <g>\n'
            html = html + '    <animateTransform id="cursor-animate"\n' +
                    '      attributeName="transform"\n' +
                    '      attributeType="XML"\n' +
                    '      type="translate"\n' +
                    '      from="0 0"\n' +
                    '      to="0 0"\n' +
                    '      dur="10s"\n' +
                    '      repeatCount="1"/>'
            html = html + '    <rect width="1" height="100%" x="0" y="0" fill="red" />'
            html = html + '    <circle r="7" cy="' + (50 * song.tracks.length + 25) + '" cx="0" fill="red" />\n'
            html = html + '  </g>'
            html = html + '  <g id="playCursorText">\n">'
            html = html + buildSvgCursorText(song, 0)
            html = html + '  </g>'
            html = html + '</g>'
            return html
        }
        function buildSvgCursorText(song, currentSongTime) {
            var heigth = 50 * song.tracks.length + 40;
            var html = ''
            html = html + '    <text x="20" y="' + (heigth - 25) + '">' + secondsToTimeString(currentSongTime) + '</text>\n'
            html = html + '    <text x="120" y="' + (heigth - 25) + '">' + secondsToTimeString(song.duration) + '</text>\n'
            html = html + '    <text x="220" y="' + (heigth - 25) + '">' + ' tempo ' + Math.round(tempoCoeff * 100) + '%' + '</text>\n'
            return html
        }
		function buildControls(song) {
			audioContext.resume();
			var o = document.getElementById('cntls');
			var html = '<h2 style="display: inline;">' + song.name + '</h2> (' + getParam("midiFile") + ')</div>';
            html = html + '<form id="modeSelect"><fieldset>\n' +
                '  <legend>Player mode:</legend>\n' +
                '\n' +

                '    <input type="radio" id="standalone" name="mode" value="standalone" checked />\n' +
                '    <label for="standalone">Standalone</label>\n' +

                '    <input type="radio" id="control" name="mode" value="control" />\n' +
                '    <label for="control">Control</label>\n' +

                '    <input type="radio" id="follow" name="mode" value="follow" />\n' +
                '    <label for="follow">Follow</label>\n' +

                '</fieldset></form>';
            html = html + '<style>\n' +
                '  #playbtn {\n' +
                '    border-radius: 50%;\n' +
                '    padding:0;\n' +
                '    flex-shrink: 0;\n' +
                '    border: 10px solid green;\n' +
                '    g.play {\n' +
                '      visibility: visible;\n' +
                '    }\n' +
                '    g.pause {\n' +
                '      visibility: hidden;\n' +
                '    }\n' +
                '  }\n' +
                '  #playbtn.playing {\n' +
                '    border: 10px solid red;\n' +
                '    g.play {\n' +
                '      visibility: hidden;\n' +
                '    }\n' +
                '    g.pause {\n' +
                '      visibility: visible;\n' +
                '    }\n' +
                '  }\n' +
                '</style>'
            html = html + '<p>' +
                '      <div style="display: inline-block">' +
                '        <button id="playbtn" style="display: inline-block">' +
                '          <svg width="100" height="100" viewBox="0 0 64 64">\n' +
                '            <g class="play">\n' +
                '               <title>Play</title>\n' +
                '               <polygon points="24,16 24,48 40,32" style="fill:green" />\n' +
                '            </g>\n' +
                '            <g class="pause">\n' +
                '               <title>Pause</title>\n' +
                '               <polygon points="16,16 16,48 24,48 24 16" style="fill:red" />\n' +
                '               <polygon points="48,16 48,48 40,48 40 16" style="fill:red" />\n' +
                '            </g>\n' +
                '         </svg>' +
                '       </button>' +
                '     </div>' +
                '     <div style="display: inline-block" id="tmr">Press Play to start or switch to Follow mode</div>' +
                '     </p>';
            html = html + '<p>' + buildSvg(song, 0) + '</p>';
            html = html + '<div id="peers_list"></div>';
            html = html + '<p>position: <input id="position" type="range" min="0" max="100" value="0" step="1" /></p>';
            html = html + '<p>tempo: <input id="tempo" type="range" min="50" max="200" value="100" step="1" /></p>';
			html = html + '<h3>Channels</h3>';
			for (var i = 0; i < song.tracks.length; i++) {
				var v = 100 * song.tracks[i].volume;
                var soloParam = getParam("solo")
                if (soloParam && soloParam !== song.tracks[i].name) {
                    v = 20 * song.tracks[i].volume
                }
                setVolume(i, v / 100, song)
				html = html + '<p>' + song.tracks[i].name + chooserIns(song.tracks[i].id, i) + '<input id="channel' + i + '" type="range" min="0" max="100" value="' + v + '" step="1" /></p>';
			}
			html = html + '<h3>Drums</h3>';
			for (var i = 0; i < song.beats.length; i++) {
				var v = 100 * song.beats[i].volume;
				html = html + '<p>' + chooserDrum(song.beats[i].id, i) + '<input id="drum' + i + '" type="range" min="0" max="100" value="' + v + '" step="1" /></p>';
			}
            html = html + '<hr />';
            html = html + '<p>Cyprus choir club</p>';
            html = html + '<p>Midi player by <a href="https://github.com/surikov/webaudiofont">WebAudioFont</a></p>';
            html = html + '<p>Frontend-only collaboration by <a href="https://github.com/dmotz/trystero">Trystero</a></p>';
			o.innerHTML = html;
            document.getElementById('playbtn').addEventListener('click', playButtonClick)
            document.getElementById('modeSelect').addEventListener('change', modeSelectChange)
			console.log('Loaded');
            var roomid = getParam("room");
            if (!roomid) {
                reopenWithRandomRoom()
            }
            var mode = getParam("mode");
            if (mode === "follow") {
                setControl(MODE_FOLLOW)
            } else {
                setControl(MODE_STANDALONE)
            }
            if (!localStorage.getItem("persistentId")) {
                let persistentId = (Math.random() + 1).toString(36).substring(7)
                localStorage.setItem("persistentId", persistentId)
            }
            var svgBackground = document.getElementById('background');
            svgBackground.onclick = function (e) {
                var x = e.offsetX / svgBackground.getBoundingClientRect().width;
                setPosition(x * song.duration)
            }
			var pos = document.getElementById('position');
			pos.oninput = function (e) {
                setPosition(pos.value / 100 * song.duration)
			};
            var tempoControl = document.getElementById('tempo');
            tempoControl.oninput = function (e) {
                setTempo(tempoControl.value / 100)
			};
			console.log('Tracks');
			for (var i = 0; i < song.tracks.length; i++) {
				setVolumeAction(i, song);
			}
			console.log('Drums');
			for (var i = 0; i < song.beats.length; i++) {
				setDrVolAction(i, song);
			}
			loadedsong = song;
		}
        function setVolume(i, v, song) {
            console.log('setVolume', i, v);
            player.cancelQueue(audioContext);
            if (v < 0.000001) {
                v = 0.000001;
            }
            song.tracks[i].volume = v;
        }
		function setVolumeAction(i, song) {
			var vlm = document.getElementById('channel' + i);
			vlm.oninput = function (e) {
                var v = vlm.value / 100;
				setVolume(i, v, song)
			};
			var sl = document.getElementById('selins' + i);
			sl.onchange = function (e) {
				var nn = sl.value;
				var info = player.loader.instrumentInfo(nn);
				player.loader.startLoad(audioContext, info.url, info.variable);
				player.loader.waitLoad(function () {
					console.log('loaded');
					song.tracks[i].info = info;
					song.tracks[i].id = nn;
				});
			};
		}
		function setDrVolAction(i, song) {
			var vlm = document.getElementById('drum' + i);
			vlm.oninput = function (e) {
				player.cancelQueue(audioContext);
				var v = vlm.value / 100;
				if (v < 0.000001) {
					v = 0.000001;
				}
				song.beats[i].volume = v;
			};
			var sl = document.getElementById('seldrm' + i);
			sl.onchange = function (e) {
				var nn = sl.value;
				var info = player.loader.drumInfo(nn);
				player.loader.startLoad(audioContext, info.url, info.variable);
				player.loader.waitLoad(function () {
					console.log('loaded');
					song.beats[i].info = info;
					song.beats[i].id = nn;
				});
			};
		}
		function chooserIns(n, track) {
			var html = '<select id="selins' + track + '">';
			for (var i = 0; i < player.loader.instrumentKeys().length; i++) {
				var sel = '';
				if (i == n) {
					sel = ' selected';
				}
				html = html + '<option value="' + i + '"' + sel + '>' + i + ': ' + player.loader.instrumentInfo(i).title + '</option>';
			}
			html = html + '</select>';
			return html;
		}
		function chooserDrum(n, beat) {
			var html = '<select id="seldrm' + beat + '">';
			for (var i = 0; i < player.loader.drumKeys().length; i++) {
				var sel = '';
				if (i == n) {
					sel = ' selected';
				}
				html = html + '<option value="' + i + '"' + sel + '>' + i + ': ' + player.loader.drumInfo(i).title + '</option>';
			}
			html = html + '</select>';
			return html;
		}
		function handleExample(path) {
			console.log(path);
			var xmlHttpRequest = new XMLHttpRequest();
			xmlHttpRequest.open("GET", path, true);
			xmlHttpRequest.responseType = "arraybuffer";
			xmlHttpRequest.onload = function (e) {
                try {
                    var arrayBuffer = xmlHttpRequest.response;
                    var midiFile = new MIDIFile(arrayBuffer);
                    var song = midiFile.parseSong();
                    startLoad(song);
                } catch (e) {
                    var o = document.getElementById('cntls');
                    o.innerHTML = `<h2>Could not load the midi file ${path}</h2>`;
                    console.log(e);
                }
			};
			xmlHttpRequest.send(null);
		}
        function getParam(param) {
            return new URL(document.URL).searchParams.get(param)
        }
        var loadButton = document.getElementById('initLoad');
        loadButton.addEventListener('click', function (e) {
            loadButton.remove()
            handleExample("../" + getParam("midiFile"))
        })
	</script>
</body>

</html>